{% extends "base.html" %}
{% block title %}Генерация документов · DMG{% endblock %}

{% block content %}

<section class="card">
  <h1>Генерация документов</h1>
  <p class="muted">Выберите договор(ы), при необходимости добавьте Приложение 1, заполните ключи и скачайте результат.</p>
</section>

<section class="card">
  <h2>1) Что генерируем</h2>

  <!-- Форма обновления состояния (GET):
       прокидываем введённые ключи через hidden, чтобы не сбивались -->
  <form method="get" action="{{ url_for('all_in_one') }}">
    <div class="chips">
      {% for f in templates %}
        <label class="chip">
          <input type="checkbox" name="t" value="{{ f }}" {% if f in selected %}checked{% endif %}>
          <span>{{ f }}</span>
        </label>
      {% endfor %}
    </div>

    <label class="chip" style="margin-top:10px;">
      <input type="checkbox" name="appendix" {% if appendix_on %}checked{% endif %}>
      <span>Добавить Приложение 1</span>
    </label>

    {% if appendix_on %}
      <div class="grid" style="margin-top:10px;">
        <label class="field" style="position:relative;">
          <span>Артист (как в Excel)</span>
          <input type="text" name="artist" id="artist-input" value="{{ artist or '' }}" autocomplete="off" placeholder="Введите имя артиста">
          <div id="artist-suggest" class="autocomplete-list" hidden></div>
        </label>
      </div>
    {% else %}
      <!-- если приложение выключено — сохраним текущее значение -->
      <input type="hidden" name="artist" value="{{ artist or '' }}">
    {% endif %}

    {% if placeholders %}
      {% for ph in placeholders %}
        <input type="hidden" name="ph:{{ ph }}" value="{{ values.get('ph:'+ph, '') }}">
      {% endfor %}
    {% endif %}

    <div class="actions">
      <button class="btn outline" type="submit">Показать поля и треки</button>
    </div>
  </form>
</section>

<section class="card">
  <h2>2) Единые ключи</h2>

  {% if placeholders %}
    <form method="post" action="{{ url_for('all_in_one_generate') }}">
      {% for s in selected %}<input type="hidden" name="selected_templates" value="{{ s }}">{% endfor %}
      <input type="hidden" name="appendix" value="{{ 'on' if appendix_on else '' }}">
      <input type="hidden" name="artist" value="{{ artist or '' }}">

      <div class="grid">
        {% for ph in placeholders %}
          <label class="field">
            <span>{{ ph }}</span>
            <input type="text" name="ph:{{ ph }}" placeholder="{{ ph }}" value="{{ values.get('ph:'+ph, '') }}">
          </label>
        {% endfor %}
      </div>

      {% if appendix_on %}
        <div class="card" style="margin-top:12px;">
          <h3>3) Треки для Приложения 1</h3>
          {% if tracks is none %}
            <p class="muted">Введите артиста выше и нажмите «Показать поля и треки».</p>
          {% elif tracks.empty %}
            <p class="muted">Треки не найдены для «{{ artist }}».</p>
          {% else %}
            <p class="muted">Отметьте треки для включения (по умолчанию — все):</p>
            <ul class="files">
              {% for i, row in tracks.iterrows() %}
                <li>
                  <label style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" name="sel" value="{{ i }}" checked>
                    <span>
                      <b>{{ row.get('track_name','') }}</b> · {{ row.get('artist_name','') }}
                      {% if row.get('isrc','') %} · ISRC: {{ row.get('isrc') }}{% endif %}
                    </span>
                  </label>
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      {% endif %}

      <div class="actions" style="margin-top:12px;">
        <button class="btn solid" type="submit">Скачать результат</button>
        <a class="btn ghost" href="{{ url_for('downloads') }}">К скачиваниям</a>
      </div>
    </form>
  {% else %}
    <p class="muted">Выберите договоры и/или включите Приложение 1 выше и нажмите «Показать поля и треки».</p>
  {% endif %}
</section>

<!-- ===== Autocomplete script ===== -->
<script>
(function(){
  const input = document.getElementById('artist-input');
  const list  = document.getElementById('artist-suggest');
  if(!input || !list) return;

  let timer = null;
  let lastQuery = "";

  function clearList(){
    list.innerHTML = "";
    list.hidden = true;
  }

  function render(items){
    if(!items || !items.length){ clearList(); return; }
    list.innerHTML = "";
    items.forEach((name) => {
      const li = document.createElement('div');
      li.className = 'autocomplete-item';
      li.textContent = name;
      li.tabIndex = 0;
      li.addEventListener('mousedown', (e) => {
        e.preventDefault();
        input.value = name;
        clearList();
      });
      list.appendChild(li);
    });
    list.hidden = false;
  }

  async function fetchSuggest(q){
    try{
      const resp = await fetch(`/api/artists?q=${encodeURIComponent(q)}`);
      if(!resp.ok) return clearList();
      const data = await resp.json();
      if(q === lastQuery) render(data);
    }catch(e){
      clearList();
    }
  }

  input.addEventListener('input', () => {
    const q = input.value.trim();
    lastQuery = q;
    if(timer) clearTimeout(timer);
    if(q.length < 1){ clearList(); return; }
    timer = setTimeout(() => fetchSuggest(q), 200);
  });

  // Закрытие по клику вне и по Esc
  document.addEventListener('click', (e) => {
    if(!list.contains(e.target) && e.target !== input){
      clearList();
    }
  });
  input.addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){ clearList(); }
  });
})();
</script>

{% endblock %}
